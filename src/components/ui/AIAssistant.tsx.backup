'use client';

import React, { useState, useEffect, useMemo, useRef } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { 
  MessageCircle, 
  X, 
  Minimize2, 
  Maximize2, 
  Send,
  Bot,
  User,
  Wifi,
  WifiOff,
  Settings
} from 'lucide-react';
import { ollamaService } from '@/services/OllamaService';
import { multiModelService } from '@/services/MultiModelService';

interface Message {
  id: string;
  type: 'user' | 'ai';
  content: string;
  timestamp: Date;
}

interface AIAssistantProps {
  className?: string;
}

export default function AIAssistant({ className }: AIAssistantProps) {
  const [isOpen, setIsOpen] = useState(false);
  const [isMinimized, setIsMinimized] = useState(false);
  const [inputValue, setInputValue] = useState('');
  const [messages, setMessages] = useState<Message[]>([
    {
      id: '1',
      type: 'ai',
      content: 'Xin ch√†o! T√¥i l√† AI Assistant c·ªßa PH√öC KHI√äM Education. T√¥i c√≥ th·ªÉ gi√∫p b·∫°n h·ªçc ngo·∫°i ng·ªØ, gi·∫£i ƒë√°p th·∫Øc m·∫Øc v·ªÅ ng·ªØ ph√°p, t·ª´ v·ª±ng, v√† nhi·ªÅu h∆°n n·ªØa. B·∫°n c·∫ßn h·ªó tr·ª£ g√¨?',
      timestamp: new Date()
    }
  ]);
  const [isLoading, setIsLoading] = useState(false);
  const [ollamaStatus, setOllamaStatus] = useState<'checking' | 'available' | 'unavailable'>('checking');
  const [isStreaming, setIsStreaming] = useState(false);
  const [availableModels, setAvailableModels] = useState<any[]>([]);
  const [selectedModel, setSelectedModel] = useState<string>('auto');
  const [modelStatus, setModelStatus] = useState<any[]>([]);
  const [hasInitialized, setHasInitialized] = useState(false);
  
  // Ref cho chat area ƒë·ªÉ scroll
  const chatAreaRef = useRef<HTMLDivElement>(null);

  // Auto-scroll xu·ªëng tin nh·∫Øn m·ªõi nh·∫•t
  const scrollToBottom = () => {
    if (chatAreaRef.current) {
      setTimeout(() => {
        chatAreaRef.current?.scrollTo({
          top: chatAreaRef.current.scrollHeight,
          behavior: 'smooth'
        });
      }, 100); // Delay nh·ªè ƒë·ªÉ ƒë·∫£m b·∫£o DOM ƒë√£ update
    }
  };

  // Auto-scroll khi c√≥ tin nh·∫Øn m·ªõi
  useEffect(() => {
    if (messages.length > 0) {
      scrollToBottom();
    }
  }, [messages]);

  // Auto-scroll khi streaming response
  useEffect(() => {
    if (isStreaming) {
      const interval = setInterval(scrollToBottom, 200);
      return () => clearInterval(interval);
    }
  }, [isStreaming]);

  // Auto-scroll khi chat m·ªü
  useEffect(() => {
    if (isOpen && !isMinimized) {
      scrollToBottom();
    }
  }, [isOpen, isMinimized]);

  // Ki·ªÉm tra Ollama status khi component mount - CH·ªà M·ªòT L·∫¶N
  useEffect(() => {
    if (!hasInitialized) {
      checkOllamaStatus();
      loadModelStatus();
      setHasInitialized(true);
    }
  }, [hasInitialized]);

  // Auto-check m·ªói 30 gi√¢y thay v√¨ 5 gi√¢y ƒë·ªÉ gi·∫£m nh√°y
  useEffect(() => {
    if (hasInitialized) {
      const interval = setInterval(() => {
        // Ch·ªâ check n·∫øu chat ƒëang m·ªü ƒë·ªÉ ti·∫øt ki·ªám t√†i nguy√™n
        if (isOpen) {
          checkOllamaStatus();
          loadModelStatus();
        }
      }, 30000); // T·ª´ 5 gi√¢y ‚Üí 30 gi√¢y
      return () => clearInterval(interval);
    }
  }, [hasInitialized, isOpen]);

  const checkOllamaStatus = async () => {
    // Tr√°nh check li√™n t·ª•c n·∫øu ƒëang check
    if (ollamaStatus === 'checking') return;
    
    console.log('üîç Checking Ollama status...');
    setOllamaStatus('checking');
    try {
      const result = await ollamaService.testConnection();
      console.log('üì° Ollama test result:', result);
      if (result.success) {
        console.log('‚úÖ Ollama available, model:', result.model);
        setOllamaStatus('available');
      } else {
        console.log('‚ùå Ollama test failed:', result.message);
        setOllamaStatus('unavailable');
      }
    } catch (error) {
      console.error('üí• Ollama check error:', error);
      setOllamaStatus('unavailable');
    }
  };

  const loadModelStatus = async () => {
    try {
      const status = multiModelService.getModelStatus();
      setModelStatus(status);
      setAvailableModels(status.filter(m => m.isAvailable));
    } catch (error) {
      console.error('üí• Error loading model status:', error);
    }
  };

  const getCurrentContext = () => {
    if (typeof window !== 'undefined') {
      const path = window.location.pathname;
      if (path.includes('/courses/japanese/n5/vocabulary')) {
        return 'B·∫°n ƒëang h·ªçc t·ª´ v·ª±ng N5 ti·∫øng Nh·∫≠t';
      } else if (path.includes('/courses/japanese/n5/grammar')) {
        return 'B·∫°n ƒëang h·ªçc ng·ªØ ph√°p N5 ti·∫øng Nh·∫≠t';
      } else if (path.includes('/courses/japanese/n5/kanji')) {
        return 'B·∫°n ƒëang h·ªçc Kanji N5 ti·∫øng Nh·∫≠t';
      } else if (path.includes('/courses/japanese/n5/listening')) {
        return 'B·∫°n ƒëang luy·ªán nghe N5 ti·∫øng Nh·∫≠t';
      }
    }
    return 'B·∫°n ƒëang ·ªü trang ch√≠nh';
  };

  // Smart AI responses d·ª±a tr√™n context v√† c√¢u h·ªèi
  const generateSmartResponse = (question: string, context: string): string => {
    const lowerQuestion = question.toLowerCase();
    
    // X·ª≠ l√Ω c√¢u h·ªèi v·ªÅ t·ª´ v·ª±ng theo level
    if (lowerQuestion.includes('t·ª´ v·ª±ng') || lowerQuestion.includes('vocabulary')) {
      // X√°c ƒë·ªãnh level (N1, N2, N3, N4, N5)
      let level = 'N5'; // Default
      if (lowerQuestion.includes('n1')) level = 'N1';
      else if (lowerQuestion.includes('n2')) level = 'N2';
      else if (lowerQuestion.includes('n3')) level = 'N3';
      else if (lowerQuestion.includes('n4')) level = 'N4';
      else if (lowerQuestion.includes('n5')) level = 'N5';
      
      // X√°c ƒë·ªãnh s·ªë l∆∞·ª£ng
      let count = 10; // Default
      if (lowerQuestion.includes('5')) count = 5;
      else if (lowerQuestion.includes('10')) count = 10;
      else if (lowerQuestion.includes('15')) count = 15;
      else if (lowerQuestion.includes('20')) count = 20;
      
      // Tr·∫£ l·ªùi theo level v√† s·ªë l∆∞·ª£ng
      if (level === 'N1') {
        if (count === 5) {
          return `üìö **5 T·ª™ V·ª∞NG N1 PH·ªî BI·∫æN NH·∫§T**

1. **ÁµåÊ∏à (keizai)** - Kinh t·∫ø
2. **ÊîøÊ≤ª (seiji)** - Ch√≠nh tr·ªã  
3. **Á§æ‰ºö (shakai)** - X√£ h·ªôi
4. **ÊñáÂåñ (bunka)** - VƒÉn h√≥a
5. **ÊïôËÇ≤ (kyouiku)** - Gi√°o d·ª•c

üí° **L∆∞u √Ω:** ${context}
üéØ **M·∫πo h·ªçc:** H√£y luy·ªán t·∫≠p nh·ªØng t·ª´ n√†y th∆∞·ªùng xuy√™n ƒë·ªÉ nh·ªõ l√¢u!`;
        }
        return `üìö **T·ª™ V·ª∞NG N1 QUAN TR·ªåNG**

1. **ÁµåÊ∏à (keizai)** - Kinh t·∫ø
2. **ÊîøÊ≤ª (seiji)** - Ch√≠nh tr·ªã
3. **Á§æ‰ºö (shakai)** - X√£ h·ªôi
4. **ÊñáÂåñ (bunka)** - VƒÉn h√≥a

üí° **L∆∞u √Ω:** ${context}
‚ùì **B·∫°n mu·ªën h·ªçc bao nhi√™u t·ª´ v·ª±ng N1?**`;
      }
      
      if (level === 'N2') {
        if (count === 5) {
          return `üìö **5 T·ª™ V·ª∞NG N2 PH·ªî BI·∫æN NH·∫§T**

1. **‰ºöÁ§æ (kaisha)** - C√¥ng ty
2. **‰ªï‰∫ã (shigoto)** - C√¥ng vi·ªác
3. **ÂÆ∂Êóè (kazoku)** - Gia ƒë√¨nh
4. **ÂèãÈÅî (tomodachi)** - B·∫°n b√®
5. **Â≠¶Ê†° (gakkou)** - Tr∆∞·ªùng h·ªçc

üí° **L∆∞u √Ω:** ${context}
üéØ **M·∫πo h·ªçc:** H√£y luy·ªán t·∫≠p nh·ªØng t·ª´ n√†y th∆∞·ªùng xuy√™n ƒë·ªÉ nh·ªõ l√¢u!`;
        }
        return `üìö **T·ª™ V·ª∞NG N2 QUAN TR·ªåNG**

1. **‰ºöÁ§æ (kaisha)** - C√¥ng ty
2. **‰ªï‰∫ã (shigoto)** - C√¥ng vi·ªác
3. **ÂÆ∂Êóè (kazoku)** - Gia ƒë√¨nh
4. **ÂèãÈÅî (tomodachi)** - B·∫°n b√®

üí° **L∆∞u √Ω:** ${context}
‚ùì **B·∫°n mu·ªën h·ªçc bao nhi√™u t·ª´ v·ª±ng N2?**`;
      }
      
      if (level === 'N3') {
        if (count === 5) {
          return `üìö **5 T·ª™ V·ª∞NG N3 PH·ªî BI·∫æN NH·∫§T**

1. **Êò†Áîª (eiga)** - Phim
2. **Èü≥Ê•Ω (ongaku)** - √Çm nh·∫°c
3. **ÊñôÁêÜ (ryouri)** - N·∫•u ƒÉn
4. **ÊóÖË°å (ryokou)** - Du l·ªãch
5. **Ë∂£Âë≥ (shumi)** - S·ªü th√≠ch

üí° **L∆∞u √Ω:** ${context}
üéØ **M·∫πo h·ªçc:** H√£y luy·ªán t·∫≠p nh·ªØng t·ª´ n√†y th∆∞·ªùng xuy√™n ƒë·ªÉ nh·ªõ l√¢u!`;
        }
        return `üìö **T·ª™ V·ª∞NG N3 QUAN TR·ªåNG**

1. **Êò†Áîª (eiga)** - Phim
2. **Èü≥Ê•Ω (ongaku)** - √Çm nh·∫°c
3. **ÊñôÁêÜ (ryouri)** - N·∫•u ƒÉn
4. **ÊóÖË°å (ryokou)** - Du l·ªãch

üí° **L∆∞u √Ω:** ${context}
‚ùì **B·∫°n mu·ªën h·ªçc bao nhi√™u t·ª´ v·ª±ng N3?**`;
      }
      
      if (level === 'N4') {
        if (count === 5) {
          return `üìö **5 T·ª™ V·ª∞NG N4 PH·ªî BI·∫æN NH·∫§T**

1. **ÈõªËªä (densha)** - T√†u ƒëi·ªán
2. **ÈßÖ (eki)** - Ga t√†u
3. **ÂàáÁ¨¶ (kippu)** - V√©
4. **ÊôÇÈñì (jikan)** - Th·ªùi gian
5. **Â†¥ÊâÄ (basho)** - N∆°i ch·ªën

üí° **L∆∞u √Ω:** ${context}
üéØ **M·∫πo h·ªçc:** H√£y luy·ªán t·∫≠p nh·ªØng t·ª´ n√†y th∆∞·ªùng xuy√™n ƒë·ªÉ nh·ªõ l√¢u!`;
        }
        return `üìö **T·ª™ V·ª∞NG N4 QUAN TR·ªåNG**

1. **ÈõªËªä (densha)** - T√†u ƒëi·ªán
2. **ÈßÖ (eki)** - Ga t√†u
3. **ÂàáÁ¨¶ (kippu)** - V√©
4. **ÊôÇÈñì (jikan)** - Th·ªùi gian

üí° **L∆∞u √Ω:** ${context}
‚ùì **B·∫°n mu·ªën h·ªçc bao nhi√™u t·ª´ v·ª±ng N4?**`;
      }
      
      // N5 (default)
      if (count === 5) {
        return `üìö **5 T·ª™ V·ª∞NG N5 PH·ªî BI·∫æN NH·∫§T**

1. **„Åì„Çì„Å´„Å°„ÅØ (konnichiwa)** - Xin ch√†o
2. **„ÅÇ„Çä„Åå„Å®„ÅÜ (arigatou)** - C·∫£m ∆°n
3. **„Åä„ÅØ„Çà„ÅÜ (ohayou)** - Ch√†o bu·ªïi s√°ng
4. **„Åï„Çà„ÅÜ„Å™„Çâ (sayounara)** - T·∫°m bi·ªát
5. **„Åô„Åø„Åæ„Åõ„Çì (sumimasen)** - Xin l·ªói

üí° **L∆∞u √Ω:** ${context}
üéØ **M·∫πo h·ªçc:** H√£y luy·ªán t·∫≠p nh·ªØng t·ª´ n√†y th∆∞·ªùng xuy√™n ƒë·ªÉ nh·ªõ l√¢u!`;
      }
      
      return `üìö **T·ª™ V·ª∞NG N5 C∆† B·∫¢N**

1. **„Åì„Çì„Å´„Å°„ÅØ (konnichiwa)** - Xin ch√†o
2. **„ÅÇ„Çä„Åå„Å®„ÅÜ (arigatou)** - C·∫£m ∆°n
3. **„Åä„ÅØ„Çà„ÅÜ (ohayou)** - Ch√†o bu·ªïi s√°ng

üí° **L∆∞u √Ω:** ${context}
‚ùì **B·∫°n mu·ªën h·ªçc bao nhi√™u t·ª´ v·ª±ng N5?**`;
    }
    
    // X·ª≠ l√Ω c√¢u h·ªèi v·ªÅ ng·ªØ ph√°p
    if (lowerQuestion.includes('ng·ªØ ph√°p') || lowerQuestion.includes('grammar') || lowerQuestion.includes('ng·ªØ ph√°o')) {
      // X√°c ƒë·ªãnh level
      let level = 'N5';
      if (lowerQuestion.includes('n1')) level = 'N1';
      else if (lowerQuestion.includes('n2')) level = 'N2';
      else if (lowerQuestion.includes('n3')) level = 'N3';
      else if (lowerQuestion.includes('n4')) level = 'N4';
      else if (lowerQuestion.includes('n5')) level = 'N5';
      
      // X√°c ƒë·ªãnh s·ªë l∆∞·ª£ng
      let count = 5;
      if (lowerQuestion.includes('5')) count = 5;
      else if (lowerQuestion.includes('10')) count = 10;
      
      if (count === 5) {
        if (level === 'N1') {
          return `üìñ **5 ƒêI·ªÇM NG·ªÆ PH√ÅP N1 TH√îNG D·ª§NG**

1. **„ÅØ (wa)** - Particle ch·ªâ ch·ªß ng·ªØ
2. **„Åå (ga)** - Particle ch·ªâ ch·ªß ng·ªØ (nh·∫•n m·∫°nh)
3. **„Çí (wo)** - Particle ch·ªâ t√¢n ng·ªØ
4. **„Å´ (ni)** - Particle ch·ªâ ƒë·ªãa ƒëi·ªÉm, th·ªùi gian
5. **„Åß (de)** - Particle ch·ªâ ph∆∞∆°ng ti·ªán, n∆°i ch·ªën

üí° **L∆∞u √Ω:** ${context}
üéØ **M·∫πo h·ªçc:** H√£y luy·ªán t·∫≠p nh·ªØng ƒëi·ªÉm ng·ªØ ph√°p n√†y th∆∞·ªùng xuy√™n!`;
        }
        
        if (level === 'N2') {
          return `üìñ **5 ƒêI·ªÇM NG·ªÆ PH√ÅP N2 TH√îNG D·ª§NG**

1. **„ÅØ (wa)** - Particle ch·ªâ ch·ªß ng·ªØ
2. **„Åå (ga)** - Particle ch·ªâ ch·ªß ng·ªØ (nh·∫•n m·∫°nh)
3. **„Çí (wo)** - Particle ch·ªâ t√¢n ng·ªØ
4. **„Å´ (ni)** - Particle ch·ªâ ƒë·ªãa ƒëi·ªÉm, th·ªùi gian
5. **„Åß (de)** - Particle ch·ªâ ph∆∞∆°ng ti·ªán, n∆°i ch·ªën

üí° **L∆∞u √Ω:** ${context}
üéØ **M·∫πo h·ªçc:** H√£y luy·ªán t·∫≠p nh·ªØng ƒëi·ªÉm ng·ªØ ph√°p n√†y th∆∞·ªùng xuy√™n!`;
        }
        
        if (level === 'N3') {
          return `üìñ **5 ƒêI·ªÇM NG·ªÆ PH√ÅP N3 TH√îNG D·ª§NG**

1. **„ÅØ (wa)** - Particle ch·ªâ ch·ªß ng·ªØ
2. **„Åå (ga)** - Particle ch·ªâ ch·ªß ng·ªØ (nh·∫•n m·∫°nh)
3. **„Çí (wo)** - Particle ch·ªâ t√¢n ng·ªØ
4. **„Å´ (ni)** - Particle ch·ªâ ƒë·ªãa ƒëi·ªÉm, th·ªùi gian
5. **„Åß (de)** - Particle ch·ªâ ph∆∞∆°ng ti·ªán, n∆°i ch·ªën

üí° **L∆∞u √Ω:** ${context}
üéØ **M·∫πo h·ªçc:** H√£y luy·ªán t·∫≠p nh·ªØng ƒëi·ªÉm ng·ªØ ph√°p n√†y th∆∞·ªùng xuy√™n!`;
        }
        
        if (level === 'N4') {
          return `üìñ **5 ƒêI·ªÇM NG·ªÆ PH√ÅP N4 TH√îNG D·ª§NG**

1. **„ÅØ (wa)** - Particle ch·ªâ ch·ªß ng·ªØ
2. **„Åå (ga)** - Particle ch·ªâ ch·ªß ng·ªØ (nh·∫•n m·∫°nh)
3. **„Çí (wo)** - Particle ch·ªâ t√¢n ng·ªØ
4. **„Å´ (ni)** - Particle ch·ªâ ƒë·ªãa ƒëi·ªÉm, th·ªùi gian
5. **„Åß (de)** - Particle ch·ªâ ph∆∞∆°ng ti·ªán, n∆°i ch·ªën

üí° **L∆∞u √Ω:** ${context}
üéØ **M·∫πo h·ªçc:** H√£y luy·ªán t·∫≠p nh·ªØng ƒëi·ªÉm ng·ªØ ph√°p n√†y th∆∞·ªùng xuy√™n!`;
        }
        
        // N5 (default)
        return `üìñ **5 ƒêI·ªÇM NG·ªÆ PH√ÅP N5 TH√îNG D·ª§NG**

1. **„ÅØ (wa)** - Particle ch·ªâ ch·ªß ng·ªØ
2. **„Åå (ga)** - Particle ch·ªâ ch·ªß ng·ªØ (nh·∫•n m·∫°nh)
3. **„Çí (wo)** - Particle ch·ªâ t√¢n ng·ªØ
4. **„Å´ (ni)** - Particle ch·ªâ ƒë·ªãa ƒëi·ªÉm, th·ªùi gian
5. **„Åß (de)** - Particle ch·ªâ ph∆∞∆°ng ti·ªán, n∆°i ch·ªën

üí° **L∆∞u √Ω:** ${context}
üéØ **M·∫πo h·ªçc:** H√£y luy·ªán t·∫≠p nh·ªØng ƒëi·ªÉm ng·ªØ ph√°p n√†y th∆∞·ªùng xuy√™n!`;
      }
      
      return `üìñ **NG·ªÆ PH√ÅP ${level} C∆† B·∫¢N**

1. **„ÅØ (wa)** - Particle ch·ªâ ch·ªß ng·ªØ
2. **„Åå (ga)** - Particle ch·ªâ ch·ªß ng·ªØ (nh·∫•n m·∫°nh)
3. **„Çí (wo)** - Particle ch·ªâ t√¢n ng·ªØ
4. **„Å´ (ni)** - Particle ch·ªâ ƒë·ªãa ƒëi·ªÉm, th·ªùi gian

üí° **L∆∞u √Ω:** ${context}
‚ùì **B·∫°n mu·ªën h·ªçc bao nhi√™u ƒëi·ªÉm ng·ªØ ph√°p ${level}?**`;
    }
    
    // X·ª≠ l√Ω c√¢u h·ªèi v·ªÅ Kanji
    if (lowerQuestion.includes('kanji')) {
      // X√°c ƒë·ªãnh level
      let level = 'N5';
      if (lowerQuestion.includes('n1')) level = 'N1';
      else if (lowerQuestion.includes('n2')) level = 'N2';
      else if (lowerQuestion.includes('n3')) level = 'N3';
      else if (lowerQuestion.includes('n4')) level = 'N4';
      else if (lowerQuestion.includes('n5')) level = 'N5';
      
      // X√°c ƒë·ªãnh s·ªë l∆∞·ª£ng
      let count = 5;
      if (lowerQuestion.includes('5')) count = 5;
      else if (lowerQuestion.includes('10')) count = 10;
      
      if (count === 5) {
        return `üàØ **5 KANJI ${level} TH√îNG D·ª§NG**

1. **‰∫∫ (hito)** - Ng∆∞·ªùi
2. **Â§ß (dai)** - L·ªõn
3. **Â∞è (shou)** - Nh·ªè
4. **Â±± (yama)** - N√∫i
5. **Â∑ù (kawa)** - S√¥ng

üí° **L∆∞u √Ω:** ${context}
üéØ **M·∫πo h·ªçc:** H√£y luy·ªán t·∫≠p vi·∫øt nh·ªØng Kanji n√†y th∆∞·ªùng xuy√™n!`;
      }
      
      return `üàØ **KANJI ${level} C∆† B·∫¢N**

1. **‰∫∫ (hito)** - Ng∆∞·ªùi
2. **Â§ß (dai)** - L·ªõn
3. **Â∞è (shou)** - Nh·ªè
4. **Â±± (yama)** - N√∫i

üí° **L∆∞u √Ω:** ${context}
‚ùì **B·∫°n mu·ªën h·ªçc bao nhi√™u Kanji ${level}?**`;
    }
    
    // X·ª≠ l√Ω c√¢u h·ªèi chung
    return `ü§ñ **AI ASSISTANT - PH√öC KHI√äM EDUCATION**

üí° **L∆∞u √Ω:** ${context}

üéØ **T√¥i c√≥ th·ªÉ gi√∫p b·∫°n:**
‚Ä¢ H·ªçc t·ª´ v·ª±ng (N1, N2, N3, N4, N5)
‚Ä¢ H·ªçc ng·ªØ ph√°p theo level
‚Ä¢ H·ªçc Kanji t·ª´ c∆° b·∫£n ƒë·∫øn n√¢ng cao
‚Ä¢ Luy·ªán nghe v√† ph√°t √¢m
‚Ä¢ Gi·∫£i ƒë√°p th·∫Øc m·∫Øc v·ªÅ ti·∫øng Nh·∫≠t

‚ùì **B·∫°n c·∫ßn h·ªó tr·ª£ g√¨ c·ª• th·ªÉ kh√¥ng?**`;
  };

  const handleSendMessage = async () => {
    if (!inputValue.trim()) return;

    const userMessage: Message = {
      id: Date.now().toString(),
      type: 'user',
      content: inputValue,
      timestamp: new Date()
    };

    setMessages(prev => [...prev, userMessage]);
    setInputValue('');
    setIsLoading(true);

    try {
      const context = getCurrentContext();
      
      // ∆ØU TI√äN 1: Multi-Model Service (GPT-4o Mini, Gemini Pro - M·∫°nh nh·∫•t)
      if (selectedModel !== 'auto' && selectedModel !== 'qwen2:0.5b') {
        try {
          console.log('üöÄ S·ª≠ d·ª•ng Multi-Model Service:', selectedModel);
          const aiResponse: Message = {
            id: (Date.now() + 1).toString(),
            type: 'ai',
            content: '',
            timestamp: new Date()
          };
          
          setMessages(prev => [...prev, aiResponse]);
          
          // G·ªçi Multi-Model Service
          const response = await multiModelService.chat(inputValue, context);
          
          setMessages(prev => 
            prev.map(msg => 
              msg.id === aiResponse.id 
                ? { ...msg, content: response.response || response.toString() }
                : msg
            )
          );
          return; // Tho√°t n·∫øu th√†nh c√¥ng
        } catch (error) {
          console.log('‚ùå Multi-Model Service failed, chuy·ªÉn sang Ollama:', error);
        }
      }
      
      // ∆ØU TI√äN 2: Ollama Local (M·∫°nh v·ª´a)
      if (ollamaStatus === 'available') {
        try {
          console.log('üè† S·ª≠ d·ª•ng Ollama Local');
          const aiResponse: Message = {
            id: (Date.now() + 1).toString(),
            type: 'ai',
            content: '',
            timestamp: new Date()
          };
          
          setMessages(prev => [...prev, aiResponse]);
          
          // Streaming response t·ª´ Ollama
          setIsStreaming(true);
          let fullResponse = '';
          
          for await (const chunk of ollamaService.streamChat(inputValue, context, selectedModel === 'auto' ? undefined : selectedModel)) {
            fullResponse += chunk;
            setMessages(prev => 
              prev.map(msg => 
                msg.id === aiResponse.id 
                  ? { ...msg, content: fullResponse }
                  : msg
              )
            );
          }
          
          setIsStreaming(false);
          return; // Tho√°t n·∫øu th√†nh c√¥ng
        } catch (error) {
          console.log('‚ùå Ollama failed, chuy·ªÉn sang Smart Fallback:', error);
        }
      }
      
      // ∆ØU TI√äN 3: Smart Fallback (Y·∫øu nh·∫•t - Ch·ªâ khi t·∫•t c·∫£ ƒë·ªÅu fail)
      console.log('üí° S·ª≠ d·ª•ng Smart Fallback');
      const smartResponse = generateSmartResponse(inputValue, context);
      const aiResponse: Message = {
        id: (Date.now() + 1).toString(),
        type: 'ai',
        content: smartResponse,
        timestamp: new Date()
      };
      setMessages(prev => [...prev, aiResponse]);
      
    } catch (error) {
      // Fallback cu·ªëi c√πng n·∫øu c√≥ l·ªói nghi√™m tr·ªçng
      console.error('üí• T·∫•t c·∫£ services ƒë·ªÅu fail, s·ª≠ d·ª•ng emergency fallback:', error);
      const context = getCurrentContext();
      const fallbackResponse = generateSmartResponse(inputValue, context);
      const errorMessage: Message = {
        id: (Date.now() + 1).toString(),
        type: 'ai',
        content: fallbackResponse,
        timestamp: new Date()
      };
      setMessages(prev => [...prev, errorMessage]);
    } finally {
      setIsLoading(false);
    }
  };

  const handleKeyPress = (e: React.KeyboardEvent) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      handleSendMessage();
    }
  };

  const toggleChat = () => {
    setIsOpen(!isOpen);
    if (isOpen) {
      setIsMinimized(false);
    }
  };

  const toggleMinimize = () => {
    setIsMinimized(!isMinimized);
  };

  return (
    <>
      <motion.div
        className={`fixed bottom-6 right-6 z-50 ${className}`}
        initial={{ scale: 0 }}
        animate={{ scale: 1 }}
        transition={{ type: "spring", stiffness: 260, damping: 20 }}
      >
        <button
          onClick={toggleChat}
          className="bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white p-4 rounded-full shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-110 relative"
          title="AI Assistant"
        >
          <MessageCircle size={24} />
          <span className="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold px-1.5 py-0.5 rounded-full border-2 border-white">
            AI
          </span>
        </button>
      </motion.div>

      <AnimatePresence>
        {isOpen && (
          <motion.div
            initial={{ opacity: 0, scale: 0.8, y: 20 }}
            animate={{ opacity: 1, scale: 1, y: 0 }}
            exit={{ opacity: 0, scale: 0.8, y: 20 }}
            transition={{ duration: 0.3, ease: "easeOut" }}
            className="fixed bottom-24 right-6 z-50 w-[500px] max-w-[90vw] bg-white dark:bg-gray-800 rounded-2xl shadow-2xl border border-gray-200 dark:border-gray-700 overflow-hidden"
          >
            {/* Model Selector Section - Kh√¥ng c√≥ header, ch·ªâ c√≥ model selector v√† n√∫t ƒëi·ªÅu khi·ªÉn */}
            {!isMinimized && (
              <div className="bg-gray-50 dark:bg-gray-900 px-4 py-3 border-b border-gray-200 dark:border-gray-700">
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-2">
                    <select
                      value={selectedModel}
                      onChange={(e) => setSelectedModel(e.target.value)}
                      disabled={ollamaStatus === 'unavailable'}
                      className={`text-xs border rounded px-2 py-1 transition-all duration-200 focus:outline-none focus:ring-2 ${
                        ollamaStatus === 'available'
                          ? 'bg-white border-gray-300 text-gray-700 focus:ring-blue-500 focus:border-blue-500 hover:border-gray-400'
                          : 'bg-gray-100 border-gray-200 text-gray-500 cursor-not-allowed'
                      }`}
                      title={
                        ollamaStatus === 'available'
                          ? 'Ch·ªçn AI model ƒë·ªÉ s·ª≠ d·ª•ng'
                          : 'Ollama ch∆∞a s·∫µn s√†ng. Vui l√≤ng kh·ªüi ƒë·ªông Ollama tr∆∞·ªõc.'
                      }
                    >
                      <option value="auto" disabled={ollamaStatus === 'unavailable'}>
                        ü§ñ [Auto]
                      </option>
                      <option value="gpt-4o-mini" disabled={ollamaStatus === 'unavailable'}>
                        üöÄ GPT-4o Mini
                      </option>
                      <option value="gpt-3.5-turbo" disabled={ollamaStatus === 'unavailable'}>
                        ‚ö° GPT-3.5 Turbo
                      </option>
                      <option value="gemini-1.5-flash" disabled={ollamaStatus === 'unavailable'}>
                        üåü Gemini 1.5 Flash
                      </option>
                      <option value="gemini-1.5-pro" disabled={ollamaStatus === 'unavailable'}>
                        üíé Gemini 1.5 Pro
                      </option>
                      <option value="qwen2:0.5b" disabled={ollamaStatus === 'unavailable'}>
                        üè† Ollama Local
                      </option>
                    </select>
                  </div>
                  
                  {/* N√∫t ƒëi·ªÅu khi·ªÉn v√† Status indicator */}
                  <div className="flex items-center gap-3">
                    {/* Status indicator ƒë∆°n gi·∫£n */}
                    <div className="flex items-center gap-2">
                      {ollamaStatus === 'checking' && (
                        <div className="w-2 h-2 bg-yellow-400 rounded-full animate-pulse" title="ƒêang ki·ªÉm tra..."></div>
                      )}
                      {ollamaStatus === 'available' && (
                        <div className="w-2 h-2 bg-green-400 rounded-full" title="S·∫µn s√†ng"></div>
                      )}
                      {ollamaStatus === 'unavailable' && (
                        <div className="w-2 h-2 bg-red-400 rounded-full" title="Kh√¥ng kh·∫£ d·ª•ng"></div>
                      )}
                    </div>
                    
                    {/* Action Buttons - Minimize v√† Close */}
                    <div className="flex items-center gap-1">
                      <button
                        onClick={toggleMinimize}
                        className="hover:bg-gray-200 dark:hover:bg-gray-700 p-1.5 rounded transition-all duration-200 hover:scale-105 active:scale-95"
                        title={isMinimized ? "Maximize" : "Minimize"}
                      >
                        {isMinimized ? <Maximize2 size={14} /> : <Minimize2 size={14} />}
                      </button>
                      <button
                        onClick={toggleChat}
                        className="hover:bg-gray-200 dark:hover:bg-gray-700 p-1.5 rounded transition-all duration-200 hover:scale-105 active:scale-95"
                        title="Close"
                      >
                        <X size={14} />
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {!isMinimized && (
              <>
                {/* Chat Area - Better spacing v√† mobile-friendly */}
                <div className="h-96 overflow-y-auto p-4 space-y-4" ref={chatAreaRef}>
                  {messages.map((message) => (
                    <div
                      key={message.id}
                      className={`flex ${message.type === 'user' ? 'justify-end' : 'justify-start'}`}
                    >
                      <div
                        className={`max-w-[85%] p-3 rounded-2xl ${
                          message.type === 'user'
                            ? 'bg-blue-600 text-white shadow-lg'
                            : 'bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100 shadow-md'
                        }`}
                      >
                        <div className="flex items-start gap-3">
                          {message.type === 'ai' && (
                            <Bot size={16} className="mt-1 flex-shrink-0 text-blue-600 dark:text-blue-400" />
                          )}
                          <div className="min-w-0 flex-1">
                            <p className="text-sm leading-relaxed">{message.content}</p>
                            <p className="text-xs opacity-70 mt-2 text-right">
                              {message.timestamp.toLocaleTimeString()}
                            </p>
                          </div>
                        </div>
                      </div>
                    </div>
                  ))}
                  
                  {/* Loading Indicator - Consistent styling */}
                  {isLoading && (
                    <div className="flex justify-start">
                      <div className="bg-gray-100 dark:bg-gray-700 p-3 rounded-2xl shadow-md max-w-[85%]">
                        <div className="flex items-center gap-3">
                          <Bot size={16} className="text-blue-600 dark:text-blue-400" />
                          <div className="flex items-center gap-3">
                            <span className="text-sm text-gray-600 dark:text-gray-300">
                              {ollamaStatus === 'available' ? 'ƒêang x·ª≠ l√Ω...' : 'ƒêang chu·∫©n b·ªã...'}
                            </span>
                            <div className="flex space-x-1">
                              <div className="w-2 h-2 bg-blue-500 rounded-full animate-bounce"></div>
                              <div className="w-2 h-2 bg-blue-500 rounded-full animate-bounce" style={{ animationDelay: '0.1s' }}></div>
                              <div className="w-2 h-2 bg-blue-500 rounded-full animate-bounce" style={{ animationDelay: '0.2s' }}></div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  )}
                </div>

                {/* Input Area - Consistent styling v√† mobile-friendly */}
                <div className="p-4 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900">
                  <div className="flex gap-3">
                    <input
                      type="text"
                      value={inputValue}
                      onChange={(e) => setInputValue(e.target.value)}
                      onKeyPress={handleKeyPress}
                      placeholder="Nh·∫≠p c√¢u h·ªèi c·ªßa b·∫°n..."
                      className="flex-1 px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-800 dark:text-white transition-all duration-200 placeholder-gray-500 dark:placeholder-gray-400"
                      disabled={isLoading}
                    />
                    <button
                      onClick={handleSendMessage}
                      disabled={!inputValue.trim() || isLoading}
                      className="px-4 py-3 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white rounded-xl hover:shadow-lg disabled:shadow-none transition-all duration-200 hover:scale-105 active:scale-95 disabled:cursor-not-allowed disabled:transform-none flex items-center justify-center min-w-[48px]"
                    >
                      <Send size={16} />
                    </button>
                  </div>
                </div>
              </>
            )}
          </motion.div>
        )}
      </AnimatePresence>
    </>
  );
}
